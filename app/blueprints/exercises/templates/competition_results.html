{% extends "base.html" %}
{% from "macros.html" import page_header, data_table, status_badge, ranking_badge, empty_state %}

{% block title %}Results - {{ competition.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    {% call page_header(
        competition.name + ' (' + competition.level + ') - Results',
        location=competition.location,
        date=competition.date
    ) %}
        <div class="d-flex gap-2 flex-wrap justify-content-end align-items-center">
            <div>{{ status_badge(result_status.published if result_status else false) }}</div>
            {% if result_status and result_status.published %}
            <form method="POST" action="{{ url_for('exercises.unpublish_results', competition_id=competition.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-warning">Unpublish Results</button>
            </form>
            {% else %}
            <form method="POST" action="{{ url_for('exercises.publish_results', competition_id=competition.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-success">Publish Results</button>
            </form>
            {% endif %}
        </div>
    {% endcall %}

    <hr>

    {% if starter_results %}
        {% call data_table(['Ranking', 'Starter'] + [exercise.name for exercise in exercises] + ['Total Points']) %}
            {% set sorted_results = starter_results|dictsort(attribute='1.total_points', reverse=true) %}
            {% for idx, (starter_id, result) in enumerate(sorted_results, 1) %}
            <tr>
                <td class="fw-bold">{{ ranking_badge(idx) }}</td>
                <td>
                    <strong>
                        {% if result.starter.person %}
                            {{ result.starter.person.given_name }} {{ result.starter.person.family_name }}
                        {% endif %}
                        {% if result.starter.dog %}
                            <br><small>({{ result.starter.dog.name }})</small>
                        {% endif %}
                    </strong>
                </td>
                {% for exercise in exercises %}
                <td class="text-center">
                    {% set points = result.exercise_scores.get(exercise.id) %}
                    {% if points is not none %}
                        <span class="badge bg-info">{{ points }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                {% endfor %}
                <td class="text-center fw-bold">
                    <span class="badge bg-primary" style="font-size: 1.1em;">
                        {{ result.total_points }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        {% endcall %}
    {% else %}
        {{ empty_state(
            'No results available yet.',
            'Points need to be entered for exercises before results can be displayed.'
        ) }}
    {% endif %}

    <div class="mt-4 d-flex gap-2">
        <a href="{{ url_for('exercises.wt_exercises', competition_id=competition.id) }}" class="btn btn-secondary">
            Back to Exercises
        </a>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            Back to Overview
        </a>
    </div>
</div>
{% endblock %}
